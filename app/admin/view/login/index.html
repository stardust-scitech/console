<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>Admin-登录</title>
        <meta name="description" content="" />
        <meta name="keywords" content="" />
        <link rel="stylesheet" type="text/css" href="../../../public/static/admin2/css/admin.css" />
        <link rel="stylesheet" type="text/css" href="../../../public/static/index/layui/css/layui.css" />
        <script type="text/javascript" src="../../../public/static/index/layui/layui.js"></script>
    </head>
    <body style="background: #fff">
        <div class="layui-container">
            <form id="form" class="layui-form login_form" action="" method="post"> 
                <!-- target="postFrame" -->
                <h2 class="text_center mar_b_30">后台登录</h2>
                <div class="layui-form-item">
                        <input id="username" type="text" name="username" required lay-verify="required" placeholder="请输入用户名" autocomplete="off" class="layui-input">
                </div>
                <div class="layui-form-item">
                        <input id="password" type="password" name="password" required lay-verify="required" placeholder="请输入密码" autocomplete="off" class="layui-input">
                </div>
                <div class="layui-form-item">
                    <input id="verifycode" type="text" name="verifycode" required lay-verify="required" placeholder="请输入两位验证码" autocomplete="off" class="layui-input fleft" style="width: 200px">
                    <img id="captcha" src="{:captcha_src()}" alt="captcha" onClick="this.src='{:captcha_src()}?'+Math.random();"/>
                </div>
                <div class="layui-form-item text_center mar_t_30">
                    <button id="submit" class="layui-btn" type="button" onclick="submitForm()";>立即提交</button>
                </div>
            </form>
            <!-- <iframe id="frameSubmit" frameborder="0" style="display:none" name="postFrame"></iframe> -->
            <!-- <iframe id="frameSubmit" style="width: 100%;height: 100%;" name="postFrame"></iframe> -->
            <script>

                layui.use('form', function ()
                {
                    var form = layui.form;
                });

                function submitForm() 
                {
                    $("#form").ajaxSubmit(function(data)
                    { 
                        // console.log(data);
                        var json = JSON.parse(data);

                        if(json.redirect == './index') 
                        {
                            location.reload();
                        }
                        else
                        {
                            Popup(json.msg, json.icon);
                            if(json.captcha)
                            {
                                document.getElementById("verifycode").value = '';
                                document.getElementById("captcha").src = json.captcha;
                                // <img id="captcha" src="{:captcha_src()}" alt="captcha" onClick="this.src='{:captcha_src()}?'+Math.random();"/>
                            }
                        }
                        // $(this).resetForm(); // 提交后重置表单
                    });
                    return false; // 必须返回false，否则表单会自己再做一次提交操作，并且页面跳转
                }

                // document.getElementById("verifycode").focus();

                var focus_count = 0;
                var verifycode = document.getElementById("verifycode");
                var password = document.getElementById("password");
                var username = document.getElementById("username");

                verifycode.focus();

                verifycode.addEventListener("focus", function(e) {
                    focus_count = 0;
                });
                password.addEventListener("focus", function(e) {
                    if(e.relatedTarget) focus_count = 1;
                });
                username.addEventListener("focus", function(e) {
                    if(e.relatedTarget) focus_count = 2;
                });

                document.onkeydown = (e) => {
                    // console.log(e.key);
                    switch (e.key) {
                        case "Enter":
                            document.getElementById("submit").click();
                            break;    
                        case "ArrowUp":
                        case "ArrowDown":
                            {
                                event.preventDefault();

                                if(e.key == "ArrowUp")
                                {
                                    if(focus_count<2) focus_count++;
                                    else focus_count = 0;
                                }
                                else if(e.key == "ArrowDown")
                                {
                                    if(focus_count>0) focus_count--;
                                    else focus_count = 2;
                                }

                                switch (focus_count) {
                                    case 0:
                                        verifycode.focus();
                                        break;
                                    case 1:
                                        password.focus();
                                        password.select();
                                        // setTimeout(function(){password.select();},0); 
                                        break;
                                    case 2:
                                        username.focus();
                                        username.select();
                                        break;
                                }
                            }
                            break;
                        case "Control":
                            if(!focus_count)
                            {
                                $("#captcha").attr('src','{:captcha_src()}?'+Math.random()); // 刷新验证码
                                verifycode.value = '';
                            }
                            break;
                    }
                }

                function Popup(msg='', icon='', time=3)
                {
                    layer.msg(msg, {icon:5, time:time*1000});
                }
            </script>
        </div>
        {include file="public/foot"}
    </body>
</html>